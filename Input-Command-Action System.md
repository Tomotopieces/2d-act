# 输入-指令-动作系统

本文档用于说明战斗场景的输入流程。

## 输入

用户的物理输入。

## 指令

指令是由用户输入转换而来的，用于记录**用户输入**。

指令管理器中存在预输入指令队列，允许用户在当前动作未执行完毕时提前输入下一个指令。系统适时将指令从队列中取出，转为合理的动作后执行。

## 动作

动作由指令与实际情况判断而来，为用户的**实际意图**。

## 输入流程

1. 用户通过输入设备进行输入；
2. 输入管理器将用户输入转换为指令；
3. 输入管理器将指令发送给指令管理器；
4. 指令管理器将接受到的指令暂存在指令队列中；

## 响应流程

1. 指令管理器清理指令队列中的过期指令；
2. 指令管理器遍历处理指令队列中的所有有效指令；
   1. 指令管理器将指令转为动作；
      - 根据实际情况判断，相同指令在不同情况下所对应的动作可能不同
   2. 指令管理器将动作发送给动作管理器；
   3. 动作管理器判断动作是否可执行
      - 优先级高的动作可以强制取消优先级低的动作
      - 当前动作的可取消性为真时，任何动作都可取消当前动作
      > 若动作因优先级或可取消性的**动作原因**未能执行，视为指令失效，保留指令在队列中
      > 若技能类动作因资源不足或冷却时间等**非动作原因**未能执行，依然视为指令生效，将指令从队列中移除
   4. 动作管理器执行动作或跳过；
   5. 动作管理器将执行结果发送给指令管理器；
   6. 指令管理器根据动作执行结果决定是否将指令从队列中移除或进行其他操作；
